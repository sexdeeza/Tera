package client.messages.commands.headgm;

import client.MapleClient;
import client.messages.Command;
import server.life.MapleLifeFactory;
import server.life.MapleMonster;
import server.life.OverrideMonsterStats;
import tools.StringUtil;

public class SpawnCommand extends Command {
    
    @Override
    public void execute(MapleClient c, String[] splitted) {
        final int mid = Integer.parseInt(splitted[0]);
        int num = Math.min(getOptionalIntArg(splitted, 1, 1), 100);
        Integer level = getNamedIntArg(splitted, 1, "lvl");
        Long hp = getNamedLongArg(splitted, 1, "hp");
        Integer exp = getNamedIntArg(splitted, 1, "exp");
        Double php = getNamedDoubleArg(splitted, 1, "php");
        Double pexp = getNamedDoubleArg(splitted, 1, "pexp");

        MapleMonster onemob;
        try {
            onemob = MapleLifeFactory.getMonster(mid);
        } catch (RuntimeException e) {
            c.getPlayer().dropMessage(5, "Error: " + e.getMessage());
            return;
        }
        if (onemob == null) {
            c.getPlayer().dropMessage(5, "Mob does not exist");
            return;
        }
        long newhp = 0;
        int newexp = 0;
        if (hp != null) {
            newhp = hp.longValue();
        } else if (php != null) {
            newhp = (long) (onemob.getMobMaxHp() * (php.doubleValue() / 100));
        } else {
            newhp = onemob.getMobMaxHp();
        }
        if (exp != null) {
            newexp = exp.intValue();
        } else if (pexp != null) {
            newexp = (int) (onemob.getMobExp() * (pexp.doubleValue() / 100));
        } else {
            newexp = onemob.getMobExp();
        }
        if (newhp < 1) {
            newhp = 1;
        }

        final OverrideMonsterStats overrideStats = new OverrideMonsterStats(newhp, onemob.getMobMaxMp(), newexp, false);
        if (num > 100)
        {
            num = 100;
        }
        for (int i = 0; i < num; i++) {
            MapleMonster mob = MapleLifeFactory.getMonster(mid);
            mob.setHp(newhp);
            if (level != null) {
                mob.changeLevel(level.intValue(), false);
            } else {
                mob.setOverrideStats(overrideStats);
            }
            c.getPlayer().getMap().spawnMonsterOnGroundBelow(mob, c.getPlayer().getPosition());
        }
    }
    
    public static String joinAfterString(String splitted[], String str) {
        for (int i = 1; i < splitted.length; i++) {
            if (splitted[i].equalsIgnoreCase(str) && i + 1 < splitted.length) {
                return StringUtil.joinStringFrom(splitted, i + 1);
            }
        }
        return null;
    }

    public static int getOptionalIntArg(String splitted[], int position, int def) {
        if (splitted.length > position) {
            try {
                return Integer.parseInt(splitted[position]);
            } catch (NumberFormatException nfe) {
                return def;
            }
        }
        return def;
    }

    public static String getNamedArg(String splitted[], int startpos, String name) {
        for (int i = startpos; i < splitted.length; i++) {
            if (splitted[i].equalsIgnoreCase(name) && i + 1 < splitted.length) {
                return splitted[i + 1];
            }
        }
        return null;
    }

    public static Long getNamedLongArg(String splitted[], int startpos, String name) {
        String arg = getNamedArg(splitted, startpos, name);
        if (arg != null) {
            try {
                return Long.parseLong(arg);
            } catch (NumberFormatException nfe) {
            }
        }
        return null;
    }

    public static Integer getNamedIntArg(String splitted[], int startpos, String name) {
        String arg = getNamedArg(splitted, startpos, name);
        if (arg != null) {
            try {
                return Integer.parseInt(arg);
            } catch (NumberFormatException nfe) {
            }
        }
        return null;
    }

    public static int getNamedIntArg(String splitted[], int startpos, String name, int def) {
        Integer ret = getNamedIntArg(splitted, startpos, name);
        if (ret == null) {
            return def;
        }
        return ret.intValue();
    }

    public static Double getNamedDoubleArg(String splitted[], int startpos, String name) {
        String arg = getNamedArg(splitted, startpos, name);
        if (arg != null) {
            try {
                return Double.parseDouble(arg);
            } catch (NumberFormatException nfe) {
            }
        }
        return null;
    }
}